#!/bin/bash
set -euo pipefail

UPDATE_URL="https://github.com/wlritchi/env"

# find remote for non-interactive updates
update_remote=
while IFS= read remote; do
    if [ "$(git -C "$WLR_ENV_PATH" remote get-url "$remote")" == "https://github.com/wlritchi/env" ]; then
        update_remote="$remote"
        break
    fi
done < <( git -C "$WLR_ENV_PATH" remote )

if [ -z "$update_remote" ]; then
    git -C "$WLR_ENV_PATH" remote add updates "$UPDATE_URL"
    update_remote=updates
fi

git -C "$WLR_ENV_PATH" fetch "$update_remote"
local_commit="$(git -C "$WLR_ENV_PATH" rev-parse HEAD)"
remote_commit="$(git -C "$WLR_ENV_PATH" rev-parse "$update_remote/main")"

# check signature
if ! "$WLR_ENV_PATH/bin/crypto/git-gpg-self" -C "$WLR_ENV_PATH" verify-commit "$remote_commit"; then
    printf 'Error: rejected signature.
' >&2
    exit 1
fi

# if nothing to do, exit early
if [ "$local_commit" == "$remote_commit" ]; then
    exit 0
fi

git -C "$WLR_ENV_PATH" merge --ff-only "$remote_commit"
